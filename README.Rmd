---
title: "HD-HuB KPI Statistics"
date: "`r lubridate::today()`"
output: 
  prettydoc::html_pretty:
    theme: cayman
    highlight: github
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.width = 12, fig.height = 6, cache = FALSE)
```

```{r, loadFunctions, echo=FALSE, include=FALSE, cache=FALSE}
source('support_stats.R')
library(BiocPkgTools)
library(dplyr)
```

<a href="http://www.denbi.de"><img src="https://www.denbi.de/templates/nbimaster/img/denbi-logo-color.svg" width="354" align="right"></a>This page collates the number of downloads and user questions for Bioconductor tools supported by the Heidelberg Centre for Human Bioinformatics as part of the German Network for Bioinformatics Infrastructure. 

You can view the code used to generate these plots at https://github.com/grimbough/denbi_reporting

# Plots

### Number of downloads

Here we show the number of downloads from unique IP addresses each month recorded at www.bioconductor.org.

```{r definePackages, echo = FALSE, include = FALSE, warning=FALSE, message=FALSE, cache = FALSE}
packages <- c('DESeq2', 'DESeq',
              'rhdf5', 'Rhdf5lib', 'biomaRt', 
              'IONiseR', 'BiocWorkflowTools', 
              'EBImage', 'SIAMCAT',
              'DEXSeq', 'beachmat',
              'RnBeads', 'YAPSA',
              'ComplexHeatmap',
              'EnrichedHeatmap', 'rGREAT',
              'HilbertCurve', 'gtrellis',
              'motus', 'ngless'
              )
```

```{r getDownloadCounts, echo = FALSE, include = FALSE, warning=FALSE, message=FALSE, cache = FALSE}
tab <- BiocPkgTools::biocDownloadStats()

all_stats_bioc <- tab %>%
  filter(Package %in% packages, Year >= 2015, !is.na(Date)) %>%
  select(-Year, -Month, -repo) %>%
  mutate(PackageComb = if_else(grepl(Package, pattern = 'hdf5'), 'rhdf5+Rhdf5lib', Package)) %>%
  mutate(PackageComb = if_else(grepl(PackageComb, pattern = 'DESeq'), 'DESeq+DESeq2', PackageComb)) 
  
tab2 <- bind_rows(
  getCondaStats(packages, bioc = TRUE),
  getCondaStats(packages, bioc = FALSE)
)

all_stats_conda <- tab2 %>%
  filter(Year >= 2015) %>%
  select(-Year, -Month) %>%
  mutate(PackageComb = if_else(grepl(Package, pattern = 'hdf5'), 'rhdf5+Rhdf5lib', Package)) %>%
  mutate(PackageComb = if_else(grepl(PackageComb, pattern = 'DESeq'), 'DESeq+DESeq2', PackageComb)) %>%
  mutate(Nb_of_distinct_IPs = Nb_of_downloads)

#all_stats <- bind_rows(all_stats_bioc, all_stats_conda)
```

```{r plotDownloads, echo = FALSE, dev='png', warning=FALSE, message = FALSE, fig.height=8}

dl_stats <- all_stats_bioc %>% 
    group_by(PackageComb, Date) %>% 
    summarise(Nb_of_distinct_IPs = sum(Nb_of_distinct_IPs)) %>%
    ungroup()

fct_levels <- dl_stats %>% 
  group_by(PackageComb) %>% 
  summarise(max = max(Nb_of_distinct_IPs)) %>% 
  arrange(desc(max)) %>% 
  magrittr::extract2("PackageComb")

dl_stats <- dl_stats %>% 
  mutate(PackageComb = factor(PackageComb, 
                                levels = fct_levels))
         
nyears <- year(today()) - min(year(all_stats_bioc$Date)) + 1

ggplot(dl_stats, aes(x = Date, y = Nb_of_distinct_IPs, 
                      fill = as.factor(year(Date)),
                      color = as.factor(year(Date)),
                      width = days_in_month(Date))) + 
    geom_bar(stat = 'identity') +
    xlab('year') +
    xlim(c(ymd("2015-01-01"), ceiling_date(max(all_stats_conda$Date)+1, "year"))) +
    ylab('Num of distinct IPs') +
    guides(fill = FALSE, color = FALSE) +
    theme_bw() +
    scale_fill_manual(values = rep(c("#A1D99B", "#31A354"), 20)[seq_len(nyears)])  +
    scale_color_manual(values = rep(c("#A1D99B", "#31A354"),20)[seq_len(nyears)]) +
    facet_wrap(~ PackageComb, scales = 'free_y') +
        theme(legend.position="bottom", 
          legend.text=element_text(size=14),
          axis.text = element_text(size = 11),
          title = element_text(size=14),
          strip.text = element_text(size = 14))
```

We also track the number of downloads recorded by conda. 

```{r plotCondaDownloads, echo = FALSE, dev='png', warning=FALSE, message = FALSE, fig.height=8}

fct_levels <- all_stats_conda %>% 
  group_by(PackageComb) %>% 
  summarise(max = max(Nb_of_downloads)) %>% 
  arrange(desc(max)) %>% 
  magrittr::extract2("PackageComb")

all_stats_conda <- all_stats_conda %>% 
    mutate(PackageComb = factor(PackageComb, 
                                levels = fct_levels))

ggplot(all_stats_conda, aes(x = Date, y = Nb_of_downloads, 
                      fill = as.factor(year(Date)),
                      color = as.factor(year(Date)),
                      width = days_in_month(Date))) + 
    geom_bar(stat = 'identity') +
    xlab('year') +
    xlim(c(ymd("2015-01-01"), ceiling_date(max(all_stats_conda$Date)+1, "year"))) +
    ylab('Num of downloads') +
    guides(fill = FALSE, color = FALSE) +
    theme_bw() +
    scale_fill_manual(values = rep(c("#A1D99B", "#31A354"), 2))  +
    scale_color_manual(values = rep(c("#A1D99B", "#31A354"),2)) +
    facet_wrap(~ PackageComb, scales = 'free_y') +
        theme(legend.position="bottom", 
          legend.text=element_text(size=14),
          axis.text = element_text(size = 11),
          title = element_text(size=14),
          strip.text = element_text(size = 14))
```


### Number of support questions

Support questions are made in a variety of locations.  Here we track the annual number of posts tagged with the name of our tools at the [Bioconductor Support Site](https://support.bioconductor.org) and [Biostars](https://www.biostars.org).  We also track the number of issues opened on any Github repositories associated with each tool. 

```{r, getPosts, echo = FALSE, include = FALSE, message=FALSE, warning=FALSE, cache = FALSE, eval = TRUE}
## submit jobs to the cluster if running on spinoza
if(Sys.info()['nodename'] %in% c("spinoza.embl.de", "seneca.embl.de")) {
    
  library(BiocParallel)
  
  registryargs <- batchtoolsRegistryargs(
    work.dir = "/tmp/",
    packages = c('httr', 'stringr', 'dplyr', 'lubridate'),
    namespaces = character(0L),
    source = c("/g/huber/users/msmith/denbi_reporting/support_stats.R")
  )
  
  param.slurm <- BatchtoolsParam(workers = length(packages) * 2,
                                 cluster = "slurm", 
                                 resources = list(ncpus=1, walltime = 600, memory = 200),
                                 registryargs = registryargs)
  
  all_posts <- 
    bpmapply(FUN = getPostsByTag,
             tag = rep(packages, each = 2),
             site = rep(c('bioc', 'biostars'), length(packages)),
             n_pages = c(65,15,25,15, rep(15, 2*(length(packages)-2))),
             USE.NAMES = FALSE,
             BPPARAM = param.slurm) %>%
    bind_rows()
} else {
  
  all_posts <- 
    mapply(FUN = getPostsByTag,
           tag = rep(packages, each = 2),
           site = rep(c('bioc', 'biostars'), length(packages)),
           n_pages = c(65,15,25,15, rep(15, 2*(length(packages)-2))),
           USE.NAMES = FALSE) %>%
    bind_rows()
}
```

```{r, processPosts, echo = FALSE, cache = FALSE, eval = TRUE}
all_posts <- all_posts %>%
    filter(!duplicated(id)) %>%
    mutate(url = stringr::str_replace(url, 'http://', 'https://'),
           software = tag, 
           tag = if_else(grepl(tag, pattern = 'hdf5'), 'rhdf5+Rhdf5lib', tag)) %>%
    mutate(tag = if_else(grepl(tag, pattern = 'DESeq'), 'DESeq+DESeq2', tag))
```

```{r, github_issuesecho = FALSE, cache = FALSE, eval = FALSE}
github_issues <- lapply(c('rhdf5', 'Rhdf5lib', 'biomaRt', 'BiocWorkflowTools', 'IONiseR'),
                        getGithubIssues, user = 'grimbough') %>%
    bind_rows(getGithubIssues('EBImage', user = 'aoles')) %>% 
    mutate(software = tag, tag = if_else(grepl(tag, pattern = 'hdf5'), 'rhdf5+Rhdf5lib', tag))
```

```{r, plotPosts, echo = FALSE, dev='png', warning=FALSE, fig.height=8, cache = FALSE, eval = FALSE}
all_posts %>% 
    bind_rows(github_issues) %>%
    mutate(tag = factor(tag, levels = fct_levels)) %>%
    filter(year(creation_date) >= 2015) %>% 
    ggplot(aes(fill = site, x = year(creation_date))) + 
    geom_bar() +
    scale_fill_manual(values = c('#1a81c2', '#8f2c47', 'grey40'),
                      name = "Site",
                      labels = c("bioconductor.org", "biostars.org", "github.com")) + 
    theme_bw() + 
    xlab('Year') +
    ylab('No. of Questions') +
    facet_wrap(~ tag, scales = 'free_y', drop = FALSE) + 
    theme(legend.position="bottom", 
          legend.text=element_text(size=14),
          axis.text = element_text(size = 11),
          title = element_text(size=14),
          strip.text = element_text(size = 14))
```


# Raw Data

Below you can find searchable tables containing the raw data used to generate the plots shown above.  Links to download tab separated text versions of this data are also provided.

## Number of downloads

### bioconductor.org

```{r, downloads-tab, echo=FALSE, cache = FALSE}
all_stats <- select(all_stats_bioc, c(4,1,2,3)) %>%
    filter(Date < today()) %>%
    arrange(desc(Date)) 
datatable(all_stats, rownames = FALSE,
          extensions = 'Buttons', 
          options = list(
    dom = 'Bfrtip',
    buttons = c('copy', 'csv', 'excel', 'pdf', 'print')
  ))
```

### Anaconda

```{r, downloads-tab-2, echo=FALSE, cache = FALSE}
all_stats <- select(all_stats_conda, c(3,1,2)) %>%
    filter(Date < today()) %>%
    arrange(desc(Date)) 
datatable(all_stats, rownames = FALSE,
          extensions = 'Buttons', 
          options = list(
    dom = 'Bfrtip',
    buttons = c('copy', 'csv', 'excel', 'pdf', 'print')
  ))
```

### Number of support questions

```{r, questions-tab, echo=FALSE, cache = FALSE, eval = FALSE}
all_posts2 <- all_posts %>%
    bind_rows(github_issues) %>%
    mutate(title = paste0("<a href='", url, "'>", title, "</a>")) %>%
    select( c(1,4,6,8)) %>%
    arrange(desc(creation_date))

datatable(all_posts2, rownames = FALSE, escape = -2,
          extensions = 'Buttons', 
          options = list(
    dom = 'Bfrtip',
    buttons = c('copy', 'csv', 'excel', 'pdf', 'print')
  ))
```
